<!DOCTYPE html>
<html lang="tt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–¢–∞—Ç–∞—Ä—á–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #1a472a, #2d5a3d); min-height: 100vh; color: #fff; }
    .app { padding: 20px; max-width: 500px; margin: 0 auto; }
    .btn { background: linear-gradient(135deg, #4ade80, #22c55e); border: none; padding: 16px 32px; border-radius: 16px; color: #1a472a; font-weight: 700; font-size: 16px; cursor: pointer; width: 100%; margin: 8px 0; }
    .btn:disabled { opacity: 0.5; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
    .btn-premium { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .card { background: rgba(255,255,255,0.1); border-radius: 20px; padding: 20px; margin: 12px 0; cursor: pointer; }
    .card.locked { opacity: 0.5; }
    .flash-card { min-height: 220px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 24px; padding: 32px; cursor: pointer; transition: all 0.3s; }
    .front { background: rgba(255,255,255,0.1); }
    .back { background: linear-gradient(135deg, #4ade80, #22c55e); color: #1a472a; }
    .quiz-btn { width: 100%; padding: 16px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; color: #fff; font-size: 16px; cursor: pointer; margin: 8px 0; text-align: left; }
    .quiz-btn.correct { background: rgba(74,222,128,0.3); border-color: #4ade80; }
    .quiz-btn.wrong { background: rgba(239,68,68,0.3); border-color: #ef4444; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .badge { background: linear-gradient(135deg, #f59e0b, #d97706); padding: 4px 12px; border-radius: 12px; font-size: 12px; }
    .title { font-size: 32px; text-align: center; margin-bottom: 20px; }
    .error { background: rgba(239,68,68,0.2); padding: 16px; border-radius: 12px; margin: 16px 0; text-align: center; }
    h2 { text-align: center; margin-bottom: 16px; }
  </style>
</head>
<body>
<div id="app" class="app"></div>
<script>
const API = 'https://tatar-lang-camelot770.amvera.io';
const FREE = 10;
const tg = window.Telegram?.WebApp;
if(tg){tg.ready();tg.expand();}

const lessons = [
  {id:1,title:"–ò—Å”ô–Ω–º–µ—Å–µ–∑!",sub:"–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è",icon:"üëã",words:[{t:"–ò—Å”ô–Ω–º–µ—Å–µ–∑",r:"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ"},{t:"–°”ô–ª–∞–º",r:"–ü—Ä–∏–≤–µ—Ç"},{t:"–•”ô–µ—Ä–ª–µ –∏—Ä—Ç”ô",r:"–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ"},{t:"–•”ô–µ—Ä–ª–µ –∫”©–Ω",r:"–î–æ–±—Ä—ã–π –¥–µ–Ω—å"},{t:"–°–∞—É –±—É–ª—ã–≥—ã–∑",r:"–î–æ —Å–≤–∏–¥–∞–Ω–∏—è"}]},
  {id:2,title:"–°–∞–Ω–Ω–∞—Ä",sub:"–ß–∏—Å–ª–∞ 1-10",icon:"üî¢",words:[{t:"–ë–µ—Ä",r:"–û–¥–∏–Ω"},{t:"–ò–∫–µ",r:"–î–≤–∞"},{t:"”®—á",r:"–¢—Ä–∏"},{t:"–î“Ø—Ä—Ç",r:"–ß–µ—Ç—ã—Ä–µ"},{t:"–ë–∏—à",r:"–ü—è—Ç—å"},{t:"–ê–ª—Ç—ã",r:"–®–µ—Å—Ç—å"},{t:"“ñ–∏–¥–µ",r:"–°–µ–º—å"},{t:"–°–∏–≥–µ–∑",r:"–í–æ—Å–µ–º—å"},{t:"–¢—É–≥—ã–∑",r:"–î–µ–≤—è—Ç—å"},{t:"–£–Ω",r:"–î–µ—Å—è—Ç—å"}]},
  {id:3,title:"–ì–∞–∏–ª”ô",sub:"–°–µ–º—å—è",icon:"üë®‚Äçüë©‚Äçüëß‚Äçüë¶",words:[{t:"”ò–Ω–∏",r:"–ú–∞–º–∞"},{t:"”ò—Ç–∏",r:"–ü–∞–ø–∞"},{t:"”ò–±–∏",r:"–ë–∞–±—É—à–∫–∞"},{t:"–ë–∞–±–∞–π",r:"–î–µ–¥—É—à–∫–∞"},{t:"–ê–ø–∞",r:"–°–µ—Å—Ç—Ä–∞"},{t:"–ê–±—ã–π",r:"–ë—Ä–∞—Ç"}]},
  {id:4,title:"–¢”©—Å–ª”ô—Ä",sub:"–¶–≤–µ—Ç–∞",icon:"üé®",words:[{t:"–ê–∫",r:"–ë–µ–ª—ã–π"},{t:"–ö–∞—Ä–∞",r:"–ß—ë—Ä–Ω—ã–π"},{t:"–ö—ã–∑—ã–ª",r:"–ö—Ä–∞—Å–Ω—ã–π"},{t:"–Ø—à–µ–ª",r:"–ó–µ–ª—ë–Ω—ã–π"},{t:"–ó”ô“£–≥”ô—Ä",r:"–°–∏–Ω–∏–π"},{t:"–°–∞—Ä—ã",r:"–ñ—ë–ª—Ç—ã–π"}]},
  {id:5,title:"–ê—à–∞–º–ª—ã–∫–ª–∞—Ä",sub:"–ï–¥–∞",icon:"üçΩÔ∏è",words:[{t:"–ò–ø–∏",r:"–•–ª–µ–±"},{t:"–°”©—Ç",r:"–ú–æ–ª–æ–∫–æ"},{t:"–ò—Ç",r:"–ú—è—Å–æ"},{t:"–ß”ô–π",r:"–ß–∞–π"},{t:"–ê–ª–º–∞",r:"–Ø–±–ª–æ–∫–æ"}]},
  {id:6,title:"–≠—á–µ–º–ª–µ–∫–ª”ô—Ä",sub:"–ù–∞–ø–∏—Ç–∫–∏",icon:"ü•§",words:[{t:"–°—É",r:"–í–æ–¥–∞"},{t:"–ß”ô–π",r:"–ß–∞–π"},{t:"–ö–æ—Ñ–µ",r:"–ö–æ—Ñ–µ"},{t:"–°”©—Ç",r:"–ú–æ–ª–æ–∫–æ"},{t:"–°–æ–∫",r:"–°–æ–∫"}]},
  {id:7,title:"–Ø—à–µ–ª—á”ô–ª”ô—Ä",sub:"–û–≤–æ—â–∏",icon:"ü•ï",words:[{t:"–ö–∏—à–µ—Ä",r:"–ú–æ—Ä–∫–æ–≤—å"},{t:"–ë”ô—Ä”ô“£–≥–µ",r:"–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å"},{t:"–ö—ã—è—Ä",r:"–û–≥—É—Ä–µ—Ü"},{t:"–ü–æ–º–∏–¥–æ—Ä",r:"–ü–æ–º–∏–¥–æ—Ä"}]},
  {id:8,title:"“ñ–∏–º–µ—à–ª”ô—Ä",sub:"–§—Ä—É–∫—Ç—ã",icon:"üçé",words:[{t:"–ê–ª–º–∞",r:"–Ø–±–ª–æ–∫–æ"},{t:"–ê—Ä–º—É—Ç",r:"–ì—Ä—É—à–∞"},{t:"”®–∑–µ–º",r:"–í–∏–Ω–æ–≥—Ä–∞–¥"},{t:"–ß–∏—è",r:"–í–∏—à–Ω—è"}]},
  {id:9,title:"–•–∞–π–≤–∞–Ω–Ω–∞—Ä",sub:"–ñ–∏–≤–æ—Ç–Ω—ã–µ",icon:"üêæ",words:[{t:"–≠—Ç",r:"–°–æ–±–∞–∫–∞"},{t:"–ú”ô—á–µ",r:"–ö–æ—à–∫–∞"},{t:"–ê—Ç",r:"–õ–æ—à–∞–¥—å"},{t:"–°—ã–µ—Ä",r:"–ö–æ—Ä–æ–≤–∞"}]},
  {id:10,title:"–°–æ—Ä–∞—É–ª–∞—Ä",sub:"–í–æ–ø—Ä–æ—Å—ã",icon:"‚ùì",words:[{t:"–ö–µ–º?",r:"–ö—Ç–æ?"},{t:"–ù”ô—Ä—Å”ô?",r:"–ß—Ç–æ?"},{t:"–ö–∞–π–¥–∞?",r:"–ì–¥–µ?"},{t:"–ö–∞–π—á–∞–Ω?",r:"–ö–æ–≥–¥–∞?"}]},
  {id:11,title:"–ö–æ—à–ª–∞—Ä",sub:"–ü—Ç–∏—Ü—ã",icon:"ü¶Ö",premium:true,words:[{t:"–ö–æ—à",r:"–ü—Ç–∏—Ü–∞"},{t:"–ö–∞—Ä–≥–∞",r:"–í–æ—Ä–æ–Ω–∞"},{t:"–ß—ã–ø—á—ã–∫",r:"–í–æ—Ä–æ–±–µ–π"},{t:"–ê–∫–∫–æ—à",r:"–õ–µ–±–µ–¥—å"}]},
  {id:12,title:"–ê—Ç–Ω–∞",sub:"–î–Ω–∏ –Ω–µ–¥–µ–ª–∏",icon:"üìÖ",premium:true,words:[{t:"–î“Ø—à”ô–º–±–µ",r:"–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫"},{t:"–°–∏—à”ô–º–±–µ",r:"–í—Ç–æ—Ä–Ω–∏–∫"},{t:"–ß”ô—Ä—à”ô–º–±–µ",r:"–°—Ä–µ–¥–∞"},{t:"–ü”ô–Ω“ó–µ—à”ô–º–±–µ",r:"–ß–µ—Ç–≤–µ—Ä–≥"},{t:"“ñ–æ–º–≥–∞",r:"–ü—è—Ç–Ω–∏—Ü–∞"}]},
  {id:13,title:"–¢–∞–±–∏–≥–∞—Ç—å",sub:"–ü—Ä–∏—Ä–æ–¥–∞",icon:"üå≤",premium:true,words:[{t:"–ê–≥–∞—á",r:"–î–µ—Ä–µ–≤–æ"},{t:"–ß”ô—á”ô–∫",r:"–¶–≤–µ—Ç–æ–∫"},{t:"–ï–ª–≥–∞",r:"–†–µ–∫–∞"},{t:"–¢–∞—É",r:"–ì–æ—Ä–∞"}]},
  {id:14,title:"”®–π",sub:"–î–æ–º",icon:"üè†",premium:true,words:[{t:"”®–π",r:"–î–æ–º"},{t:"–ë“Ø–ª–º”ô",r:"–ö–æ–º–Ω–∞—Ç–∞"},{t:"–ò—à–µ–∫",r:"–î–≤–µ—Ä—å"},{t:"–¢”ô—Ä”ô–∑”ô",r:"–û–∫–Ω–æ"}]},
  {id:15,title:"–ü—Ä–æ—Ñ–µ—Å—Å–∏—è",sub:"–ü—Ä–æ—Ñ–µ—Å—Å–∏–∏",icon:"üë®‚Äç‚öïÔ∏è",premium:true,words:[{t:"–£–∫—ã—Ç—É—á—ã",r:"–£—á–∏—Ç–µ–ª—å"},{t:"–¢–∞–±–∏–±",r:"–í—Ä–∞—á"},{t:"–°–∞—Ç—É—á—ã",r:"–ü—Ä–æ–¥–∞–≤–µ—Ü"},{t:"–ê—à–ø–∞–∑",r:"–ü–æ–≤–∞—Ä"}]},
];

let state = {screen:'home',lesson:null,cardIdx:0,flipped:false,quiz:[],qIdx:0,score:0,selected:null,done:[],xp:0,premium:false,error:null,loading:false};

function load(){
  try{const s=localStorage.getItem('tatar');if(s){const d=JSON.parse(s);state.done=d.done||[];state.xp=d.xp||0;state.premium=d.premium||false;}}catch(e){}
  render();
}

function save(){localStorage.setItem('tatar',JSON.stringify({done:state.done,xp:state.xp,premium:state.premium}));}

function render(){
  const app=document.getElementById('app');
  if(state.screen==='home') app.innerHTML=homeHTML();
  else if(state.screen==='cards') app.innerHTML=cardsHTML();
  else if(state.screen==='quiz') app.innerHTML=quizHTML();
  else if(state.screen==='result') app.innerHTML=resultHTML();
  else if(state.screen==='premium') app.innerHTML=premiumHTML();
}

function homeHTML(){
  const locked=(l)=>!state.premium && l.id>FREE;
  return `
    <div class="header">
      <div>${state.premium?'<span class="badge">‚≠ê PRO</span>':''}</div>
      <div>‚≠ê ${state.xp} XP</div>
    </div>
    <div class="title">üáπüáØ –¢–∞—Ç–∞—Ä—á–∞</div>
    ${!state.premium?`<div class="card" onclick="showPremium()" style="text-align:center;background:rgba(245,158,11,0.2)">‚≠ê –û—Ç–∫—Ä–æ–π –≤—Å–µ ${lessons.length} —É—Ä–æ–∫–æ–≤!</div>`:''}
    <div style="margin:16px 0;opacity:0.8">${state.done.length}/${lessons.length} –ø—Ä–æ–π–¥–µ–Ω–æ</div>
    ${lessons.map(l=>`
      <div class="card ${locked(l)?'locked':''}" onclick="${locked(l)?'showPremium()':'startLesson('+l.id+')'}">
        <div style="display:flex;align-items:center;gap:12px">
          <span style="font-size:24px">${state.done.includes(l.id)?'‚úÖ':l.icon}</span>
          <div><b>${l.title}</b><div style="opacity:0.7;font-size:14px">${l.sub}</div></div>
          ${locked(l)?'<span style="margin-left:auto">üîí</span>':''}
        </div>
      </div>
    `).join('')}
  `;
}

function cardsHTML(){
  const l=state.lesson;
  const w=l.words[state.cardIdx];
  const total=l.words.length;
  return `
    <div class="header"><button class="btn btn-secondary" onclick="goHome()" style="width:auto;padding:10px 16px">‚Üê –ù–∞–∑–∞–¥</button><div>${state.cardIdx+1}/${total}</div></div>
    <h2>${l.title}</h2>
    <div class="flash-card ${state.flipped?'back':'front'}" onclick="flipCard()">
      ${state.flipped?`<div style="font-size:28px;font-weight:700">${w.r}</div><div style="margin-top:12px;opacity:0.7">${w.t}</div>`:`<div style="font-size:32px;font-weight:800">${w.t}</div><div style="margin-top:16px;opacity:0.5">üëÜ –ù–∞–∂–º–∏ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞</div>`}
    </div>
    <div style="display:flex;gap:12px;margin-top:20px">
      <button class="btn btn-secondary" onclick="prevCard()" ${state.cardIdx===0?'disabled':''} style="flex:1">‚Üê</button>
      <button class="btn" onclick="nextCard()" style="flex:2">${state.cardIdx===total-1?'–¢–µ—Å—Ç ‚Üí':'–î–∞–ª—å—à–µ ‚Üí'}</button>
    </div>
  `;
}

function quizHTML(){
  const q=state.quiz[state.qIdx];
  return `
    <div class="header"><button class="btn btn-secondary" onclick="goHome()" style="width:auto;padding:10px 16px">‚Üê –ù–∞–∑–∞–¥</button><div>${state.qIdx+1}/${state.quiz.length}</div></div>
    <h2>–¢–µ—Å—Ç</h2>
    <div class="card" style="text-align:center"><div style="font-size:20px;font-weight:700">${q.question}</div></div>
    ${q.options.map((o,i)=>`<button class="quiz-btn ${state.selected?(o===q.answer?'correct':o===state.selected?'wrong':''):''}" onclick="answer('${o.replace(/'/g,"\\'")}')" ${state.selected?'disabled':''}>${o}</button>`).join('')}
    ${state.selected?`<button class="btn" onclick="nextQ()">${state.qIdx===state.quiz.length-1?'–†–µ–∑—É–ª—å—Ç–∞—Ç':'–î–∞–ª—å—à–µ ‚Üí'}</button>`:''}
  `;
}

function resultHTML(){
  const pct=Math.round(state.score/state.quiz.length*100);
  return `
    <div style="text-align:center;padding-top:40px">
      <div style="font-size:80px">${pct>=70?'üéâ':'üí™'}</div>
      <h2>${pct>=70?'–ë–∏–∫ —è—Ö—à—ã!':'–Ø—Ö—à—ã!'}</h2>
      <div class="card" style="text-align:center">
        <div style="font-size:42px;font-weight:800;color:#4ade80">${state.score}/${state.quiz.length}</div>
        <div style="margin-top:8px">+${state.score*10} XP</div>
      </div>
      <button class="btn" onclick="goHome()">–ì–æ—Ç–æ–≤–æ ‚úì</button>
    </div>
  `;
}

function premiumHTML(){
  return `
    <div class="header"><button class="btn btn-secondary" onclick="goHome()" style="width:auto;padding:10px 16px">‚Üê –ù–∞–∑–∞–¥</button></div>
    <div style="text-align:center">
      <div style="font-size:64px">‚≠ê</div>
      <h2>Premium</h2>
      <p style="opacity:0.7;margin-bottom:24px">–í—Å–µ ${lessons.length} —É—Ä–æ–∫–æ–≤ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π</p>
      ${state.error?`<div class="error">${state.error}</div>`:''}
      <button class="btn btn-premium" onclick="buyPremium(1)" ${state.loading?'disabled':''}>1 –º–µ—Å ‚Äî 100 ‚≠ê Stars</button>
      <button class="btn btn-premium" onclick="buyPremium(3)" ${state.loading?'disabled':''}>3 –º–µ—Å ‚Äî 250 ‚≠ê Stars</button>
      <button class="btn btn-premium" onclick="buyPremium(12)" ${state.loading?'disabled':''}>12 –º–µ—Å ‚Äî 800 ‚≠ê Stars</button>
      <button class="btn btn-secondary" onclick="testPremium()">üß™ –¢–µ—Å—Ç Premium</button>
    </div>
  `;
}

function goHome(){state.screen='home';state.error=null;render();}
function showPremium(){state.screen='premium';render();}

function startLesson(id){
  state.lesson=lessons.find(l=>l.id===id);
  state.cardIdx=0;
  state.flipped=false;
  state.screen='cards';
  render();
}

function flipCard(){state.flipped=!state.flipped;render();}
function prevCard(){if(state.cardIdx>0){state.cardIdx--;state.flipped=false;render();}}
function nextCard(){
  if(state.cardIdx<state.lesson.words.length-1){state.cardIdx++;state.flipped=false;render();}
  else startQuiz();
}

function startQuiz(){
  const words=[...state.lesson.words].sort(()=>Math.random()-0.5).slice(0,Math.min(5,state.lesson.words.length));
  state.quiz=words.map(w=>{
    const isT=Math.random()>0.5;
    const correct=isT?w.t:w.r;
    const others=state.lesson.words.filter(x=>x!==w).sort(()=>Math.random()-0.5).slice(0,2);
    const opts=[correct,...others.map(x=>isT?x.t:x.r)].sort(()=>Math.random()-0.5);
    return {question:isT?`"${w.r}" = ?`:`"${w.t}" = ?`,options:opts,answer:correct};
  });
  state.qIdx=0;state.score=0;state.selected=null;state.screen='quiz';render();
}

function answer(o){
  if(state.selected)return;
  state.selected=o;
  if(o===state.quiz[state.qIdx].answer)state.score++;
  render();
}

function nextQ(){
  if(state.qIdx<state.quiz.length-1){state.qIdx++;state.selected=null;render();}
  else{
    if(!state.done.includes(state.lesson.id))state.done.push(state.lesson.id);
    state.xp+=state.score*10;
    save();
    state.screen='result';render();
  }
}

function testPremium(){state.premium=true;save();goHome();}

async function buyPremium(months){
  state.loading=true;state.error=null;render();
  try{
    const res=await fetch(`${API}/api/create-invoice`,{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':tg?.initData||''},
      body:JSON.stringify({months})
    });
    const data=await res.json();
    if(data.invoice_url){
      if(tg?.openInvoice){
        tg.openInvoice(data.invoice_url,(status)=>{
          if(status==='paid'){state.premium=true;save();goHome();}
          state.loading=false;render();
        });
      }else{window.open(data.invoice_url);state.loading=false;render();}
    }else throw new Error('No URL');
  }catch(e){
    state.error='–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã. –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.';
    state.loading=false;render();
  }
}

load();
</script>
</body>
</html>
